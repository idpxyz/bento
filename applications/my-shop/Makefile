.PHONY: help fmt lint test test-cov clean dev

# Python è§£é‡Šå™¨ï¼ˆæ™ºèƒ½æ£€æµ‹ï¼šä¼˜å…ˆè™šæ‹Ÿç¯å¢ƒï¼‰
PYTHON := $(shell \
	if [ -f .venv/bin/python3 ]; then echo .venv/bin/python3; \
	elif [ -f .venv/bin/python ]; then echo .venv/bin/python; \
	elif command -v python3 >/dev/null 2>&1; then echo python3; \
	else echo "python"; fi)

# é»˜è®¤ç›®æ ‡
help:
	@echo "my-shop - Makefile å‘½ä»¤"
	@echo ""
	@echo "Python: $(PYTHON)"
	@echo ""
	@echo "å¼€å‘å‘½ä»¤:"
	@echo "  make fmt          - æ ¼å¼åŒ–ä»£ç ï¼ˆRuffï¼‰"
	@echo "  make lint         - ä»£ç æ£€æŸ¥ï¼ˆRuffï¼‰"
	@echo "  make test         - è¿è¡Œæµ‹è¯•ï¼ˆPytestï¼‰"
	@echo "  make test-cov     - è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š"
	@echo "  make dev          - å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼ˆFastAPIï¼‰"
	@echo "  make clean        - æ¸…ç†ç¼“å­˜å’Œæ„å»ºæ–‡ä»¶"
	@echo ""

# ä»£ç æ ¼å¼åŒ–
fmt:
	@echo "ğŸ¨ æ ¼å¼åŒ–ä»£ç ..."
	$(PYTHON) -m ruff check --fix .
	$(PYTHON) -m ruff format .

# ä»£ç æ£€æŸ¥
lint:
	@echo "ğŸ” ä»£ç æ£€æŸ¥..."
	$(PYTHON) -m ruff check .

# è¿è¡Œæµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	PYTHONPATH=.:../../src $(PYTHON) -m pytest tests/ -v

# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡
test-cov:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•ï¼ˆå¸¦è¦†ç›–ç‡ï¼‰..."
	PYTHONPATH=.:../../src $(PYTHON) -m pytest tests/ --cov=contexts --cov-report=html --cov-report=term-missing
	@echo "ğŸ“Š è¦†ç›–ç‡æŠ¥å‘Š: htmlcov/index.html"

# æ¸…ç†æ„å»ºæ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†ç¼“å­˜æ–‡ä»¶..."
	rm -rf htmlcov/ .coverage .pytest_cache/
	find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete
	@echo "âœ… æ¸…ç†å®Œæˆ"

# å¼€å‘æ¨¡å¼
dev:
	@echo "ğŸ”§ å¯åŠ¨å¼€å‘æœåŠ¡å™¨..."
	PYTHONPATH=.:../../src $(PYTHON) -m uvicorn main:app --reload --host 0.0.0.0 --port 8000
