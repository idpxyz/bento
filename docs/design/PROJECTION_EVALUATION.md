# Projection / OutboxProjector å®ç°è¯„ä¼°

**æ—¥æœŸ**: 2025-11-04  
**è¯„ä¼°å¯¹è±¡**: `old/infrastructure/projection/projector.py`

---

## ğŸ” ç»„ä»¶åˆ†æ

### OutboxProjector çš„æ ¸å¿ƒåŠŸèƒ½

**OutboxProjector** æ˜¯ **Transactional Outbox Pattern** çš„å…³é”®ç»„ä»¶ï¼š

1. **è½®è¯¢ Outbox è¡¨**
   - æŸ¥è¯¢ `status='NEW'` çš„äº‹ä»¶
   - ä½¿ç”¨ `FOR UPDATE SKIP LOCKED` è¡Œçº§é”
   - æ”¯æŒå¤šç§Ÿæˆ·åˆ†ç‰‡ï¼ˆæŒ‰ `tenant_id`ï¼‰

2. **å‘å¸ƒåˆ°æ¶ˆæ¯æ€»çº¿**
   - è°ƒç”¨ `EventBus.publish()` å‘å¸ƒäº‹ä»¶
   - æ”¯æŒ Pulsar / Kafka ç­‰

3. **çŠ¶æ€ç®¡ç†**
   - æˆåŠŸï¼šæ ‡è®°ä¸º `SENT`
   - å¤±è´¥ï¼šé‡è¯•è®¡æ•° +1ï¼Œè¶…è¿‡ `MAX_RETRY` æ ‡è®°ä¸º `ERR`

4. **æ€§èƒ½ä¼˜åŒ–**
   - æ‰¹é‡å¤„ç†ï¼ˆé»˜è®¤ 200 æ¡ï¼‰
   - è‡ªé€‚åº”ä¼‘çœ ï¼ˆæœ‰ç§¯å‹ 0.1sï¼Œç©ºé—²æŒ‡æ•°é€€é¿ï¼‰
   - å¹¶å‘å®‰å…¨ï¼ˆå¤šå®ä¾‹å¹¶è¡Œå¤„ç†ï¼‰

---

## âœ… **æ˜¯å¦éœ€è¦å®ç°ï¼Ÿ**

### **å¼ºçƒˆæ¨èï¼šéœ€è¦å®ç°** â­â­â­â­â­

**ç†ç”±**ï¼š

1. âœ… **Outbox Pattern çš„å®Œæ•´å®ç°**
   - Phase 2 å·²ç»å®ç°äº† Outbox è¡¨ç»“æ„å’Œå†™å…¥
   - **Projector æ˜¯è¯»å–å’Œå‘å¸ƒçš„å…³é”®ç»„ä»¶**
   - æ²¡æœ‰ Projectorï¼ŒOutbox ä¸­çš„äº‹ä»¶æ— æ³•è¢«å‘å¸ƒ

2. âœ… **ä¸ç°æœ‰æ¶æ„ç´§å¯†é›†æˆ**
   - ä¾èµ– `application.ports.message_bus` (å·²å®šä¹‰)
   - ä¾èµ– `persistence.sqlalchemy.outbox_sql` (å·²å­˜åœ¨)
   - æ˜¯ **UoW + Outbox æ•´åˆ**çš„å®Œæˆéƒ¨åˆ†

3. âœ… **äº‹ä»¶é©±åŠ¨æ¶æ„çš„æ ¸å¿ƒ**
   - ä¿è¯äº‹ä»¶æœ€ç»ˆä¸€è‡´æ€§
   - æ”¯æŒå¤šç§Ÿæˆ·å’Œæ°´å¹³æ‰©å±•
   - æä¾›å¯é çš„äº‹ä»¶æŠ•é€’

4. âœ… **å®é™…é¡¹ç›®çš„å¿…è¦ç»„ä»¶**
   - å‡ ä¹æ‰€æœ‰ä½¿ç”¨ Outbox çš„é¡¹ç›®éƒ½éœ€è¦ Projector
   - æ˜¯äº‹ä»¶é©±åŠ¨æ¶æ„çš„**æ ‡å‡†ç»„ä»¶**

---

## ğŸ“Š æ¶æ„ä½ç½®

### åœ¨ Bento æ¶æ„ä¸­çš„ä½ç½®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Application Layer                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           MessageBus Port (Protocol)                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚ implements
                                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Infrastructure Layer                            â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         OutboxProjector (Background Service)       â”‚   â”‚
â”‚  â”‚  - è½®è¯¢ Outbox è¡¨ (status='NEW')                    â”‚   â”‚
â”‚  â”‚  - è°ƒç”¨ MessageBus.publish()                        â”‚   â”‚
â”‚  â”‚  - æ›´æ–°çŠ¶æ€ (SENT/ERR)                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                        â†“ uses                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚        MessageBus Adapters                          â”‚   â”‚
â”‚  â”‚  - PulsarEventBus                                   â”‚   â”‚
â”‚  â”‚  - KafkaEventBus                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                        â†“ uses                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚        Outbox Table (SQLAlchemy)                    â”‚   â”‚
â”‚  â”‚  - å­˜å‚¨å¾…å‘å¸ƒäº‹ä»¶                                    â”‚   â”‚
â”‚  â”‚  - status: NEW â†’ SENT â†’ ERR                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ å®ç°æ–¹æ¡ˆ

### å»ºè®®çš„ç›®å½•ç»“æ„

```
src/
â””â”€â”€ infrastructure/
    â””â”€â”€ projection/
        â”œâ”€â”€ __init__.py
        â”œâ”€â”€ projector.py          # OutboxProjector å®ç°
        â””â”€â”€ config.py              # é…ç½®å¸¸é‡
```

### éœ€è¦è°ƒæ•´çš„åœ°æ–¹

1. **ä¾èµ– MessageBus Port**
   ```python
   from application.ports.message_bus import MessageBus
   # è€Œä¸æ˜¯ old ç³»ç»Ÿä¸­çš„ AbstractEventBus
   ```

2. **ä¾èµ– Outbox PO**
   ```python
   from persistence.sqlalchemy.outbox_sql import OutboxPO
   # ä½¿ç”¨ Bento çš„ Outbox å®ç°
   ```

3. **é€‚é… Bento æ¶æ„**
   - ä½¿ç”¨ Bento çš„ DomainEvent ç»“æ„
   - éµå¾ª Bento çš„å‘½åçº¦å®š
   - é›†æˆåˆ° Bento çš„å¯åŠ¨æµç¨‹

---

## ğŸ“‹ å®ç°è®¡åˆ’

### Phase 2.5: OutboxProjector å®ç°ï¼ˆå»ºè®®æ–°å¢ï¼‰

**å·¥ä½œé‡**: 1-2 å¤©

#### ä»»åŠ¡åˆ—è¡¨

- [ ] **2.5.1 åˆ›å»º OutboxProjector**
  ```bash
  src/infrastructure/projection/
  â”œâ”€â”€ __init__.py
  â”œâ”€â”€ projector.py          # OutboxProjector å®ç°
  â””â”€â”€ config.py              # é…ç½®ï¼ˆBATCH_SIZE, MAX_RETRY ç­‰ï¼‰
  ```

- [ ] **2.5.2 é›†æˆæµ‹è¯•**
  - æµ‹è¯•è½®è¯¢é€»è¾‘
  - æµ‹è¯•æ¶ˆæ¯å‘å¸ƒ
  - æµ‹è¯•é‡è¯•æœºåˆ¶
  - æµ‹è¯•å¤šç§Ÿæˆ·åˆ†ç‰‡

- [ ] **2.5.3 æ–‡æ¡£**
  - ä½¿ç”¨æŒ‡å—
  - é…ç½®è¯´æ˜
  - ç›‘æ§æŒ‡æ ‡

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### åœ¨ Bento ä¸­çš„ä½¿ç”¨

```python
# bootstrap.py æˆ– main.py
from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker
from infrastructure.projection import OutboxProjector
from adapters.messaging.pulsar import PulsarEventBus
from application.ports.message_bus import MessageBus

# åˆ›å»º Session Factory
engine = create_async_engine(POSTGRES_DSN)
session_factory = async_sessionmaker(engine, expire_on_commit=False)

# åˆ›å»º MessageBus (Pulsar)
pulsar_bus = PulsarEventBus(pulsar_client, topic_template="tenant-{tenant}")
message_bus: MessageBus = pulsar_bus

# åˆ›å»º Projector
projector = OutboxProjector(
    session_factory=session_factory,
    message_bus=message_bus,
    tenant_id="tenant-001",
    batch_size=200
)

# å¯åŠ¨ï¼ˆåå°ä»»åŠ¡ï¼‰
asyncio.create_task(projector.run_forever())

# ä¼˜é›…å…³é—­
async def shutdown():
    await projector.stop()
```

---

## ğŸ”„ ä¸ç°æœ‰ç»„ä»¶çš„é›†æˆ

### 1. ä¸ UoW çš„é›†æˆ

```python
# UoW commit æ—¶å†™å…¥ Outbox
async with uow:
    order = Order.create(...)
    await uow.orders.save(order)  # è§¦å‘é¢†åŸŸäº‹ä»¶
    await uow.commit()  # äº‹ä»¶å†™å…¥ Outbox è¡¨

# Projector å¼‚æ­¥è½®è¯¢å¹¶å‘å¸ƒ
# (åœ¨åå°è¿è¡Œ)
```

### 2. ä¸ MessageBus çš„é›†æˆ

```python
# Projector è°ƒç”¨ MessageBus Port
await message_bus.publish(events)  # å®ç°å¯ä»¥æ˜¯ Pulsar/Kafka
```

### 3. ä¸ Outbox è¡¨çš„é›†æˆ

```python
# æŸ¥è¯¢ Outbox è¡¨
stmt = select(OutboxPO).where(
    OutboxPO.tenant_id == tenant_id,
    OutboxPO.status == "NEW"
).with_for_update(skip_locked=True)
```

---

## ğŸ“Š å¯¹æ¯”åˆ†æ

### Old ç³»ç»Ÿ vs Bento å®ç°

| ç‰¹æ€§ | Old ç³»ç»Ÿ | Bento å®ç°ï¼ˆå»ºè®®ï¼‰ |
|------|---------|-------------------|
| **EventBus æ¥å£** | `AbstractEventBus` | `MessageBus` (Protocol) |
| **Outbox PO** | `old/persistence/.../outbox.py` | `persistence.sqlalchemy.outbox_sql` |
| **DomainEvent** | `old/domain/base/event.py` | `domain.domain_event` |
| **Session Factory** | `async_sessionmaker` | ç›¸åŒ |
| **é…ç½®** | ç¡¬ç¼–ç å¸¸é‡ | å¯é…ç½®åŒ– |

### éœ€è¦è°ƒæ•´çš„åœ°æ–¹

1. âœ… **æ¥å£é€‚é…**: `AbstractEventBus` â†’ `MessageBus` Protocol
2. âœ… **PO å¼•ç”¨**: ä½¿ç”¨ Bento çš„ OutboxPO
3. âœ… **äº‹ä»¶ç±»å‹**: ä½¿ç”¨ Bento çš„ DomainEvent
4. âœ… **å‘½åçº¦å®š**: éµå¾ª Bento é£æ ¼

---

## âœ… æœ€ç»ˆå»ºè®®

### **å¼ºçƒˆæ¨èå®ç°** â­â­â­â­â­

**ç†ç”±æ€»ç»“**ï¼š

1. âœ… **æ¶æ„å®Œæ•´æ€§**: Outbox Pattern çš„å®Œæ•´å®ç°
2. âœ… **å®é™…éœ€æ±‚**: å‡ ä¹æ‰€æœ‰äº‹ä»¶é©±åŠ¨é¡¹ç›®éƒ½éœ€è¦
3. âœ… **é›†æˆç´§å¯†**: ä¸ç°æœ‰ç»„ä»¶æ— ç¼é›†æˆ
4. âœ… **å·¥ä½œé‡å¯æ§**: çº¦ 1-2 å¤©å³å¯å®Œæˆ
5. âœ… **ä»·å€¼å·¨å¤§**: æä¾›å¯é çš„äº‹ä»¶æŠ•é€’æœºåˆ¶

### å®ç°ä¼˜å…ˆçº§

**ä¼˜å…ˆçº§**: â­â­â­â­â­ **é«˜**

**å»ºè®®é˜¶æ®µ**: **Phase 2.5** (åœ¨ Phase 2 å®Œæˆåç«‹å³å®ç°)

**åŸå› **:
- Phase 2 å·²ç»å®ç°äº† Outbox è¡¨ç»“æ„å’Œå†™å…¥
- Projector æ˜¯ Outbox Pattern çš„**å¦ä¸€åŠ**
- å®Œæ•´å®ç°åï¼Œäº‹ä»¶é©±åŠ¨æ¶æ„æ‰èƒ½æ­£å¸¸å·¥ä½œ

---

## ğŸ“ æ€»ç»“

### ç»“è®º

**OutboxProjector æ˜¯å¿…éœ€çš„ç»„ä»¶**ï¼Œåº”è¯¥å®ç°ã€‚

### å®ç°å»ºè®®

1. âœ… **ç«‹å³å®ç°**: ä½œä¸º Phase 2 çš„è¡¥å……
2. âœ… **éµå¾ªæ¶æ„**: ä½¿ç”¨ Bento çš„ Port-Adapter æ¨¡å¼
3. âœ… **ä¿æŒå…¼å®¹**: ä¸ old ç³»ç»Ÿçš„åŠŸèƒ½ä¿æŒä¸€è‡´
4. âœ… **å®Œå–„æµ‹è¯•**: å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯•
5. âœ… **æ–‡æ¡£å®Œå–„**: ä½¿ç”¨æŒ‡å—å’Œæœ€ä½³å®è·µ

---

**è¿™ä¸ªç»„ä»¶éå¸¸é‡è¦ï¼Œå»ºè®®ç«‹å³å®ç°ï¼** ğŸš€

