.PHONY: all build generate register docs serve-docs install lint clean help version-new version-list verify-compatibility test convert-md schema-check schema-monitor schema-monitor-init api api-dev api-prod api
.DEFAULT_GOAL := help

# å®šä¹‰ Schema ç›®å½•
SCHEMA_DIR := $(shell dirname $(realpath $(lastword $(MAKEFILE_LIST))))

# é»˜è®¤ç›®æ ‡
all: build generate docs


# å®‰è£…ä¾èµ–
install:
	@echo "ğŸ”§ å®‰è£…ä¾èµ–..."
	pip install pydantic==2.* pyyaml requests mkdocs-material pytest pytest-asyncio markdown beautifulsoup4

# ç¼–è¯‘ schema
build:
	@echo "ğŸ”¨ ç¼–è¯‘ schema..."
	python -m idp.framework.infrastructure.schema.cli.schemactl build

# ç”Ÿæˆ Pydantic æ¨¡å‹
generate:
	@echo "ğŸ”„ ç”Ÿæˆ Pydantic æ¨¡å‹..."
	python -m idp.framework.infrastructure.schema.cli.schemactl generate

# æ³¨å†Œ schema åˆ° Schema Registry
register:
	@echo "ğŸ“¡ æ³¨å†Œ schema åˆ° Pulsar Schema Registry..."
	@# ä¼˜å…ˆä½¿ç”¨å°å†™ urlï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨å¤§å†™ URL
	@URL_VALUE=""; \
	if [ -n "$(url)" ]; then \
		URL_VALUE="$(url)"; \
	elif [ -n "$(URL)" ]; then \
		URL_VALUE="$(URL)"; \
	fi; \
	\
	# å¦‚æœ URL ä»¥ pulsar:// å¼€å¤´ï¼Œå°è¯•è‡ªåŠ¨è½¬æ¢ä¸º Admin HTTP URL \
	if echo "$$URL_VALUE" | grep -q "^pulsar://"; then \
		HOST_PORT=$$(echo "$$URL_VALUE" | sed 's|^pulsar://||'); \
		HOST=$$(echo "$$HOST_PORT" | cut -d':' -f1); \
		echo "âš ï¸ æ£€æµ‹åˆ° Pulsar åè®® URLï¼Œå°†è‡ªåŠ¨è½¬æ¢ä¸º Admin HTTP URL"; \
		echo "  - åŸå§‹ URL: $$URL_VALUE"; \
		URL_VALUE="http://$$HOST:8080"; \
		echo "  - è½¬æ¢å URL: $$URL_VALUE"; \
	fi; \
	\
	# éªŒè¯ URL æ ¼å¼æ˜¯å¦ä¸º HTTP \
	if [ -n "$$URL_VALUE" ]; then \
		if ! echo "$$URL_VALUE" | grep -q "^http"; then \
			echo "âš ï¸ URL åº”è¯¥ä»¥ http:// æˆ– https:// å¼€å¤´"; \
			echo "  è¯·ä½¿ç”¨ Pulsar Admin HTTP URL (é»˜è®¤ç«¯å£ 8080)ï¼Œè€Œä¸æ˜¯ Pulsar åè®® URL (é»˜è®¤ç«¯å£ 6650)"; \
			echo "  ä¾‹å¦‚: http://192.168.8.137:8080"; \
			URL_VALUE="http://$$URL_VALUE"; \
			echo "  å°è¯•è‡ªåŠ¨ä¿®å¤ä¸º: $$URL_VALUE"; \
		fi; \
		python -m idp.framework.infrastructure.schema.cli.schemactl register --url $$URL_VALUE; \
	else \
		python -m idp.framework.infrastructure.schema.cli.schemactl register; \
	fi

# è½¬æ¢ Markdown åˆ° HTML
convert-md:
	@echo "ğŸ“„ è½¬æ¢ Markdown æ–‡ä»¶åˆ° HTML..."
	@if [ -f "USAGE.md" ]; then \
		echo "ğŸ“ å¤„ç†ä½¿ç”¨æŒ‡å—..."; \
		mkdir -p $(SCHEMA_DIR)/docs/guides; \
		cp USAGE.md $(SCHEMA_DIR)/docs/guides/usage.md; \
		mkdir -p $(SCHEMA_DIR)/generated/html; \
		cp USAGE.md $(SCHEMA_DIR)/generated/html/usage.md; \
		python -c "import sys; sys.path.append('/workspace'); from src.idp.framework.infrastructure.schema.cli.schemactl import generate_html_from_md; generate_html_from_md('$(SCHEMA_DIR)/generated/html/usage.md', '$(SCHEMA_DIR)/generated/html/usage.html', 'Schema Center ä½¿ç”¨æŒ‡å—')"; \
		cd $(SCHEMA_DIR)/generated/html && ln -sf usage.html how-to-use.html 2>/dev/null || true; \
	fi

# ç”Ÿæˆæ–‡æ¡£
docs: convert-md
	@echo "ğŸ“ ç”Ÿæˆ schema æ–‡æ¡£..."
	python -m idp.framework.infrastructure.schema.cli.schemactl docs

# å¯åŠ¨æ–‡æ¡£æœåŠ¡
serve-docs: convert-md
	@echo "ğŸš€ å¯åŠ¨æ–‡æ¡£æœåŠ¡å™¨ï¼Œè®¿é—® http://localhost:8000 æŸ¥çœ‹æ–‡æ¡£"
	@cd $(SCHEMA_DIR)/generated/html && python -m http.server 8000

# åˆ›å»ºæ–°çš„ Schema (ä½¿ç”¨æ–¹å¼: make create NAME=EventName FORMAT=proto DESC="æè¿°")
create:
	@if [ -z "$(NAME)" ]; then \
		echo "âŒ ç¼ºå°‘å‚æ•°: make create NAME=EventName FORMAT=proto DESC=\"æè¿°\""; \
		exit 1; \
	fi
	@echo "ğŸ†• åˆ›å»ºæ–° Schema: $(NAME)..."
	python -m idp.framework.infrastructure.schema.cli.schemactl create \
		--name $(NAME) \
		--format $(FORMAT) \
		--desc "$(DESC)"

# åˆ›å»ºæ–°ç‰ˆæœ¬ Schema (ä½¿ç”¨æ–¹å¼: make version-new NAME=EventName VERSION=2)
version-new:
	@if [ -z "$(NAME)" ] || [ -z "$(VERSION)" ]; then \
		echo "âŒ ç¼ºå°‘å‚æ•°: make version-new NAME=EventName VERSION=2"; \
		exit 1; \
	fi
	@echo "ğŸ”– åˆ›å»º Schema æ–°ç‰ˆæœ¬: $(NAME) v$(VERSION)..."
	python -m idp.framework.infrastructure.schema.cli.schemactl version-new \
		--name $(NAME) \
		--version $(VERSION)

# åˆ—å‡º Schema çš„æ‰€æœ‰ç‰ˆæœ¬ (ä½¿ç”¨æ–¹å¼: make version-list NAME=EventName)
version-list:
	@if [ -z "$(NAME)" ]; then \
		echo "âŒ ç¼ºå°‘å‚æ•°: make version-list NAME=EventName"; \
		exit 1; \
	fi
	@echo "ğŸ“‹ åˆ—å‡º Schema ç‰ˆæœ¬: $(NAME)..."
	python -m idp.framework.infrastructure.schema.cli.schemactl version-list \
		--name $(NAME)

# éªŒè¯ Schema å…¼å®¹æ€§ (ä½¿ç”¨æ–¹å¼: make verify-compatibility NAME=EventName VERSION=2 MODE=BACKWARD)
verify-compatibility:
	@if [ -z "$(NAME)" ] || [ -z "$(VERSION)" ]; then \
		echo "âŒ ç¼ºå°‘å‚æ•°: make verify-compatibility NAME=EventName VERSION=2 MODE=BACKWARD"; \
		exit 1; \
	fi
	@if [ -z "$(MODE)" ]; then \
		MODE="BACKWARD"; \
	fi
	@echo "ğŸ” éªŒè¯ Schema å…¼å®¹æ€§: $(NAME) v$(VERSION) ($(MODE))..."
	python -m idp.framework.infrastructure.schema.cli.schemactl verify-compatibility \
		--name $(NAME) \
		--version $(VERSION) \
		--mode $(MODE)

# è¿è¡Œå•å…ƒæµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
	pytest -xvs tests/

# æ£€æŸ¥ schema æ–‡ä»¶
lint:
	@echo "ğŸ” æ£€æŸ¥ schema æ–‡ä»¶æ ¼å¼..."
	find proto -name "*.proto" -exec protoc --proto_path=. {} \;
	find avro -name "*.avsc" -exec python -c "import json; json.load(open('{}'))" \;
	find json -name "*.json" -exec python -c "import json; json.load(open('{}'))" \;

# æ¸…ç†ç”Ÿæˆçš„æ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†ç”Ÿæˆçš„æ–‡ä»¶..."
	rm -rf generated/models/*
	rm -rf generated/proto/*
	rm -rf docs/schemas/*
	find . -name "__pycache__" -exec rm -rf {} +

# Schema ç›‘æ§å‘½ä»¤
schema-check:
	@echo "ğŸ” æ£€æŸ¥ Schema å¥åº·çŠ¶æ€..."
	python -m idp.framework.infrastructure.schema.monitor.schema_monitor_cli check $(if $(url),--url $(url),)

schema-monitor:
	@echo "ğŸ“¡ å¯åŠ¨ Schema ç›‘æ§æœåŠ¡..."
	python -m idp.framework.infrastructure.schema.monitor.schema_monitor_cli start $(if $(url),--url $(url),) $(if $(interval),--interval $(interval),)

# è®¾ç½®å¿…è¦çš„ç›®å½•
schema-monitor-init:
	@echo "ğŸ› ï¸ åˆå§‹åŒ– Schema ç›‘æ§ç¯å¢ƒ..."
	@mkdir -p $(SCHEMA_DIR)/monitor
	@touch $(SCHEMA_DIR)/monitor/schema_monitor.log
	@touch $(SCHEMA_DIR)/monitor/schema_monitor_errors.log

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "Schema ç®¡ç†å·¥å…·å‘½ä»¤:"
	@echo ""
	@echo "  make install      - å®‰è£…ä¾èµ–"
	@echo "  make build        - ç¼–è¯‘æ‰€æœ‰ schema"
	@echo "  make generate     - ç”Ÿæˆ Pydantic æ¨¡å‹"
	@echo "  make register     - æ³¨å†Œ schema åˆ° Pulsar Schema Registry"
	@echo "    æ”¯æŒä¸¤ç§å‚æ•°æ–¹å¼: make register URL=http://192.168.1.1:8080 æˆ– make register url=http://192.168.1.1:8080"
	@echo "    æ³¨æ„: å¿…é¡»ä½¿ç”¨ Pulsar Admin HTTP URL (é»˜è®¤ç«¯å£ 8080)ï¼Œè€Œä¸æ˜¯ Pulsar åè®® URL (é»˜è®¤ç«¯å£ 6650)"
	@echo "  make docs         - ç”Ÿæˆæ–‡æ¡£"
	@echo "  make serve-docs   - å¯åŠ¨æ–‡æ¡£æœåŠ¡å™¨"
	@echo "  make convert-md   - è½¬æ¢ Markdown æ–‡ä»¶åˆ° HTML"
	@echo "  make create NAME=EventName FORMAT=proto DESC=\"æè¿°\" - åˆ›å»ºæ–° Schema"
	@echo "  make lint         - æ£€æŸ¥ schema æ–‡ä»¶"
	@echo "  make clean        - æ¸…ç†ç”Ÿæˆçš„æ–‡ä»¶"
	@echo "  make all          - æ‰§è¡Œ build, generate å’Œ docs"
	@echo ""
	@echo "ç‰ˆæœ¬æ§åˆ¶ä¸å…¼å®¹æ€§:"
	@echo "  make version-new NAME=EventName VERSION=2 - åˆ›å»º Schema æ–°ç‰ˆæœ¬"
	@echo "  make version-list NAME=EventName - åˆ—å‡º Schema çš„æ‰€æœ‰ç‰ˆæœ¬"
	@echo "  make verify-compatibility NAME=EventName VERSION=2 MODE=BACKWARD - éªŒè¯ Schema å…¼å®¹æ€§"
	@echo "  make test - è¿è¡Œå•å…ƒæµ‹è¯•"
	@echo ""
	@echo "å…¼å®¹æ€§æ¨¡å¼(MODE):"
	@echo "  BACKWARD - æ–°ç‰ˆæœ¬å¯ä»¥è¯»å–æ—§ç‰ˆæœ¬æ•°æ® (é»˜è®¤)"
	@echo "  FORWARD  - æ—§ç‰ˆæœ¬å¯ä»¥è¯»å–æ–°ç‰ˆæœ¬æ•°æ®"
	@echo "  FULL     - å®Œå…¨å…¼å®¹ (BACKWARD + FORWARD)"
	@echo "  NONE     - ä¸è¦æ±‚å…¼å®¹æ€§"
	@echo ""
	@echo "ç¤ºä¾‹:"
	@echo "  make create NAME=UserLoggedIn FORMAT=proto DESC=\"ç”¨æˆ·ç™»å½•äº‹ä»¶\""
	@echo "  make version-new NAME=UserLoggedIn VERSION=2"
	@echo "  make verify-compatibility NAME=UserLoggedIn VERSION=2 MODE=BACKWARD"
	@echo "  make all"
	@echo ""
	@echo "ç¯å¢ƒå˜é‡:"
	@echo "  PULSAR_ADMIN_URL  - Pulsar Admin API URL (ç”¨äº register å‘½ä»¤)"
	@echo ""
	@echo "Schema ç›‘æ§å‘½ä»¤:"
	@echo "  make schema-check - æ£€æŸ¥ Schema å¥åº·çŠ¶æ€"
	@echo "  make schema-monitor - å¯åŠ¨ Schema ç›‘æ§æœåŠ¡"
	@echo "  make schema-monitor-init - åˆå§‹åŒ– Schema ç›‘æ§ç¯å¢ƒ"
	@echo ""
	@echo "ç¤ºä¾‹"
	@echo "  make schema-monitor url=http://192.168.1.1:8080 interval=10"
	@echo "  make schema-check url=http://192.168.1.1:8080"
	@echo "  make schema-monitor-init url=http://192.168.1.1:8080"

# Schema ç›‘æ§ API
.PHONY: api api-dev api-prod

# å¯åŠ¨Schemaç›‘æ§APIæœåŠ¡ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
api-dev:
	@echo "å¯åŠ¨Schemaç›‘æ§APIæœåŠ¡ (å¼€å‘æ¨¡å¼)"
	python -m idp.framework.api.schema.cli --host 0.0.0.0 --port 8000 --reload --debug

# å¯åŠ¨Schemaç›‘æ§APIæœåŠ¡ï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰
api-prod:
	@echo "å¯åŠ¨Schemaç›‘æ§APIæœåŠ¡ (ç”Ÿäº§æ¨¡å¼)"
	python -m idp.framework.api.schema.cli --host 0.0.0.0 --port 8000

# å¯åŠ¨Schemaç›‘æ§APIæœåŠ¡ï¼ˆé»˜è®¤å¼€å‘æ¨¡å¼ï¼‰
api: api-dev




