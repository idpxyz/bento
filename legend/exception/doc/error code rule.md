# 错误码设计规范文档

## 1. 文档概述
本文档定义了系统中统一的六位错误码（Error Code）设计规范，旨在帮助开发团队快速定位问题来源、层级和具体错误类型，提升运维效率和系统可维护性。

## 2. 错误码结构
错误码由 6 位数字组成，结构如下：
```
[L][MM][EEE]
```
- **L（Layer）— 1 位**：表示错误所在的层级。
- **MM（Module）— 2 位**：表示业务子域或模块。
- **EEE（Error）— 3 位**：表示模块内具体的错误类型。

### 2.1 Layer（L）
为了更精细地定位问题，可在 L 位基础上引入子层级（S），将第一位扩展为两位：
```
[LS][MM][EEE]
```
- **LS（Layer & Sub-layer）— 2 位**：第一位表示主层级，第二位表示子层级。

| LS 位 | 主层级 (L) | 子层级 (S) | 说明                                                |
|-------|------------|------------|---------------------------------------------------|
| 10    | 1          | 0          | Presentation 层 - 通用基础校验、路由、响应处理                      |
| 11    | 1          | 1          | Presentation 层 - Web 控制器（Controller）                       |
| 12    | 1          | 2          | Presentation 层 - API 接口层（DTO 映射、输入校验）                 |
| 20    | 2          | 0          | Application 层 - 通用用例编排                                 |
| 21    | 2          | 1          | Application 层 - Command Handler                               |
| 22    | 2          | 2          | Application 层 - Query Handler                                 |
| 30    | 3          | 0          | Domain 层 - 实体/值对象                                         |
| 31    | 3          | 1          | Domain 层 - 聚合根/聚合服务                                     |
| 32    | 3          | 2          | Domain 层 - 领域服务/领域事件                                   |
| 40    | 4          | 0          | Infrastructure 层 - 通用技术实现（DB、MQ、HTTP 客户端）            |
| 41    | 4          | 1          | Infrastructure 层 - 持久化（Repository 实现）                     |
| 42    | 4          | 2          | Infrastructure 层 - 外部适配器（第三方 SDK、文件存储、缓存）        |
| 50    | 5          | 0          | Ports & Adapters 层 - 通用端口/适配器                              |
| 51    | 5          | 1          | Ports & Adapters 层 - Presentation 适配器（Controller->Domain）   |
| 52    | 5          | 2          | Ports & Adapters 层 - Infrastructure 适配器（Domain->外部系统）  |

示例：
- `114001`：LS=11（Presentation→Controller），MM=04（Routing），EEE=001（DTO 缺少字段）
- `312200`：LS=31（Domain→聚合根），MM=22，EEE=200（外部依赖异常）

### 2.2 Module（MM） Module（MM）
- 按照**子域**或**业务模块**进行划分，使用两位数字表示。
- 例如：
  - `01`：订单子域 (Order)
  - `02`：库存子域 (Inventory)
  - `03`：客户子域 (Customer)
  - `04`：路由子域 (Routing)
  - …

### 2.3 Error Type（EEE）
模块内错误码按区间划分：
| 范围       | 含义                               |
|-----------|----------------------------------|
| 001–099   | 基础校验/格式校验                      |
| 100–199   | 业务规则/领域异常                      |
| 200–299   | 外部依赖（数据库、MQ、HTTP）异常         |
| 300–399   | 系统内部错误（NullPointer、并发、资源不足） |
| 400–499   | 安全/权限/鉴权错误                     |
| 500–599   | API 层请求/参数错误                   |

## 3. 典型错误码示例
以“路由子域（04）”为例：

| 错误码  | 组成            | 含义                                           |
|--------|-----------------|----------------------------------------------|
| 104001 | 1–04–001        | Presentation：路由请求 DTO 缺少必填字段               |
| 204100 | 2–04–100        | Application：创建路由用例时，参数合法但不满足最低站点数业务规则 |
| 304200 | 3–04–200        | Domain：RoutePlan 聚合根校验失败，坐标点超出范围     |
| 404300 | 4–04–300        | Infrastructure：写入路由缓存到 Redis 失败           |
| 504400 | 5–04–400        | Ports & Adapters：KafkaRoutePublisher 适配器鉴权失败 |

## 4. 实施步骤
1. **定义层级码**：团队统一约定并在所有服务中共享。
2. **划分模块码**：按子域/模块分配两位码，如子域过大可二级拆分。
3. **确定错误区间**：依据业务场景微调 EEE 区间。
4. **文档化维护**：在团队 Wiki/代码库中维护错误码清单。
5. **代码实现**：
   - 使用 `enum` 或常量类管理错误码。
   - 全局异常处理器统一封装返回结构：
     ```json
     {
       "code": "304200",
       "message": "RoutePlan 坐标点超出范围",
       "details": null
     }
     ```
6. **监控告警**：
   - Prometheus/Grafana 按前缀分类统计。
   - 依赖异常激增触发告警。

## 5. 扩展与国际化
- **错误码扩展**：超过 999 个错误时，可细分三级模块或增加前缀。
- **多语言支持**：将错误码与多语言资源文件映射，实现国际化。

## 6. 附录
- **错误码清单模板**：见团队 Wiki。
- **最佳实践**：结合日志上下文输出完整错误信息。
- **参考文献**：
  - 《Domain-Driven Design》 Eric Evans
  - 微服务错误码设计最佳实践文章

