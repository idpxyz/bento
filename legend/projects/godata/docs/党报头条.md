下面把“**新闻头条级**”（如今日头条/大门户）在**个性化页面**上的典型**业务与工程约束**，落到**可执行的设计与实现清单**。你可以把它直接嫁接到「Wagtail 作为 CMS +（推荐：Headless）Next.js 前端」或「Wagtail SSR + React 岛」架构中。

---

## 1) 约束总览 → 设计原则

| 类别          | 头条级约束                                      | 设计原则（可执行）                                                    |
| ----------- | ------------------------------------------ | ------------------------------------------------------------ |
| **时延**      | 首屏 p95 ≤ **800ms**；Feed 接口 p95 ≤ **150ms** | 两段式：**候选召回 ≤ 60ms** → **重排/组板 ≤ 60ms**；剩余预算留给个性化异步区域与网络波动    |
| **时效**      | 发稿到全量曝光 ≤ **5–10s**                        | 发布即刻：**事件总线**→ **索引增量刷新**→ **CDN/片段缓存精准失效**                  |
| **去重/同题聚类** | 同一“事件/话题”只保留一个代表卡片                         | 离线 **story-cluster**（LSH/SimHash/嵌入聚类）+ 在线 **MMR/DPP** 多样化去重 |
| **多样性**     | 类目/来源/观点曝光配额                               | **受限最优化**（配额+惩罚项）在 **Slate 组板**阶段执行                          |
| **来源配额**    | 单来源在一屏 ≤ N                                 | Slate 组板 hard constraints                                    |
| **负反馈**     | 跨屏/跨会话生效                                   | 用户画像中维护 **blocklist/降权标签**，召回前先过滤                            |
| **冷启动**     | 新用户、新内容也要被看到                               | **探索率**（ε-greedy/UCB/Thompson），并以安全阈值护栏                      |
| **可信与安全**   | 敏感/低质/标题党降权或拦截                             | **内容安全评分**多通道（NLP/规则/人工复核），进入特征并可作硬拦截                        |
| **编辑共治**    | 置顶、频道必显、突发优先                               | **Editorial Override** 在 **最后组板**阶段应用，仍受底线安全审计               |
| **广告合规**    | 广告密度与标识                                    | 广告槽位单独优化，不与自然内容混排或有显著标注                                      |
| **实验与稳定**   | A/B、灰度且防 KPI 投机                            | 关键指标护栏：**阅读时长/完读率** 优先于 CTR；异常检测与回滚                          |

---

## 2) 端到端架构（落地到 Wagtail + 前端）

**Wagtail（内容治理）**

* 结构化字段：`topic_id / story_cluster_id / source_id / category / geo / publish_at / quality_score / safety_flags`。
* 发布钩子：发送 `ArticlePublished` 事件 → Kafka/PubSub。
* Snippet/Taxonomy：来源白名单、敏感词词典、权威媒体标注、专题配置、编辑置顶。
* 前台用：REST/GraphQL 暴露 **文章主体 + 组板所需特征**（含安全/质量/权威/新旧标记）。

**在线推荐服务（API）**

1. **多路召回（≤60ms）**：

   * 协同/向量召回、热门趋势、地理/频道、编辑精选、探索桶等；
   * 先应用**硬过滤**：安全/拉黑/重复曝光。
2. **重排打分（≤60ms）**：

   * 目标：最大化 **E\[有效阅读时长]** + 次级目标（互动/订阅/转化）；
   * 特征：短期会话（近10分钟行为）、长期画像、内容嵌入、质量/安全、上下文（时段/设备/地理）。
3. **Slate 组板（≤30ms）**（关键）：

   * **受限最优化**：满足配额与多样性，在 K=30~~50 的候选中选 N=10~~15。
   * 支持**编辑规则**（置顶/必显/禁显）与广告槽位。

**前端渲染**

* **Headless（推荐）**：Next.js SSR/ISR；首屏主体 **ISR 缓存**，个性化区块走**边缘中间件/客户端异步**。
* **Wagtail SSR**：频道/详情页面片段缓存 + **React 岛**渲染个性化组件。
* **缓存失效**：按 `story_cluster_id`、`channel` 精准 purge；启用 **stale-while-revalidate**。

**数据闭环**

* 行为日志：曝光、点击、停留、滚动、完读、负反馈类型（不感兴趣、拉黑来源、屏蔽关键词）。
* **特征库/特征服务**：在线低延迟（Redis/Feast + Redis/Scylla）；离线训练（Spark/Flink + Parquet）。

---

## 3) Slate 受限最优化（核心算法）

> 目标：在满足“头条级”硬约束下，挑选一屏内容（Slate），最大化“价值”。

**硬约束（示例）**

* `per_source ≤ 2`；`per_category ≤ 3`；`min_fresh = 2（近2小时新稿）`；`0~1 条深度长文`；`ad_slots = {pos:5}`
* **去重**：同 `story_cluster_id` ≤ 1

**目标函数（多目标合成为单目标）**

$$
\max_{S} \sum_{i \in S} \Big( w_1 \cdot \text{ERT}_i + w_2 \cdot \text{Qual}_i + w_3 \cdot \text{Auth}_i \Big) \;-\; \lambda \cdot \text{Redundancy}(S)
$$

* `ERT`：预估有效阅读时长（而非纯 CTR）
* `Redundancy(S)`：相似度惩罚（内容向量余弦/主题相同）

**近似求解（贪心 + 约束检查）**

```python
def build_slate(candidates, N, quotas, pinned=[]):
    slate = list(pinned)  # 编辑置顶先放入，但仍需通过安全/重复检查
    state = init_quota_state(quotas, slate)
    for item in sorted(candidates, key=score, reverse=True):
        if violates(item, state): 
            continue
        if is_near_duplicate(item, slate): 
            continue
        slate.append(item)
        update(state, item)
        if len(slate) == N: 
            break
    return diversify_with_mmr(slate, alpha=0.7)  # 二次重排提升多样性
```

* 若对最优性要求更高，可用 **ILP** 或 **Lagrangian Relaxation**；在线建议采用**贪心+MMR/DPP**，满足时延预算。

---

## 4) 多样性与去重：可执行规则

* **同题聚类**：离线用 **SimHash + 句向量（e5/SGPT）** 聚类，产出 `story_cluster_id`。
* **在线去重**：同 `story_cluster_id` 只取质量最高者；同源同标题相似度 > 0.9 的直接过滤。
* **多样化（MMR）**：

  $$
  \text{MMR}(i) = \lambda \cdot \text{Rel}(i) - (1-\lambda)\max_{j\in S} \text{sim}(i,j)
  $$

  `λ` 典型 0.6–0.8。
* **来源/观点平衡**：维护 `source_tier` 与 `stance` 标签，设置每屏最小/最大配额。

---

## 5) 内容安全与可信（生产护栏）

1. **多通道评分**：NLP 分类（涉政/涉黄/低俗/歧视等）、规则库、版权/侵权、虚假信息来源库；聚合为 `safety_flags` 与 `safety_score`。
2. **发布策略**：

   * 高风险：**拦截 + 人审**；
   * 中风险：降权并限制曝光上限；
   * 低风险：正常流转。
3. **权威优先**：权威媒体 `auth_score` 加权，突发事件时触发**权威优先模式**。
4. **指标护栏**：当 CTR↑ 但 **完读率/ERT 下降** 触发自动回滚或降权（防标题党）。

---

## 6) 冷启动与探索

* **新用户**：频道热点 + 地理热点 + 高可信权威 + 轻量探索（ε=0.05）。
* **新内容**：在相近用户群做小流量**多臂老虎机**试探；设置 **bad-case 保护阈值**（如 1 分钟内负反馈比>阈值即下线）。
* **发布后 30–60 分钟**：动态调整探索权重，基于早期质量指标（ERT/完读率/评论质量）。

---

## 7) 前端页装配（契约与缓存）

**页面契约（示例）**

```json
{
  "tenant": "news-a",
  "page": "home",
  "version": "2025-08-04T10:00:00Z",
  "slots": [
    {"id":"top_lead","type":"story","N":1, "constraints":{"per_source":1, "must_new":true}},
    {"id":"headline","type":"list","N":6, "constraints":{"per_source":2,"per_category":3}},
    {"id":"trending","type":"list","N":5, "constraints":{"time_window":"6h"}},
    {"id":"ad_5","type":"ad","pos":5}
  ]
}
```

* 由 **Wagtail 后台（Layout-as-Data）** 配置并版本化；
* 前端 **按契约请求** 组板 API，返回各 slot 的 slate；
* **缓存 key**：`site:{id}:page:{name}:ver:{hash}:geo:{region}:device:{t}`；
* **失效**：文章发布/撤稿 → 计算受影响 slot → 精准 purge + ISR revalidate。

---

## 8) 数据指标与 A/B

* **核心 KPI**：有效阅读时长（ERT）、完读率、7/30 日留存、负反馈率、作者与来源覆盖度、话题覆盖度。
* **实验**：分桶固定（Cookied/Bucketing），**实验时长/样本量**预估；关键指标设\*\*“跌停保护”\*\*自动回滚。
* **反作弊**：设备指纹/速率限制/行为一致性；剔除异常点击与机器人流量。

---

## 9) 与 Wagtail 的集成要点

* **内容模型**：为算法提供必要的结构化特征（来源、话题、聚类、权威、敏感、地理、图文/视频时长等）。
* **发布钩子**：`after_publish_page` → 事件总线 → 搜索/召回索引更新 + 缓存精准失效。
* **编辑共治**：置顶/必显/禁显字段，进入组板时的 **pinned/exclude** 列表。
* **预览**：编辑侧预览携带 `page_id + version`，前端走 Preview Mode 拉草稿数据，但仍通过安全/去重校验链路。

---

## 10) 立即可做的交付物（我可以为你补齐）

1. **Wagtail 模型补充**：`story_cluster_id / safety_flags / auth_score / editorial_flags` 字段与后台表单。
2. **事件/索引**：Kafka 事件 schema、Flink/Spark 增量索引 job。
3. **Slate 服务**：召回、重排、组板（含约束贪心 + MMR）参考实现与 gRPC/HTTP API。
4. **前端契约**：页面 slot 契约 JSON Schema、Next.js 客户端与边缘中间件样例。
5. **缓存失效脚本**：按 cluster/频道的精准 purge 与 ISR on-demand revalidate。
6. **指标与看板**：埋点协议、ETL、Grafana/Superset 看板模板。

---

如果你给出**目标时延预算、每屏槽位/配额规则、来源/类目体系、当前 Wagtail 模型**，我可以把**Slate 组板服务的代码骨架**和**Wagtail 集成钩子**（Python + FastAPI/ASGI）直接写出来，并附上 **缓存 Key 规范**与 **Purging 拓扑**。
