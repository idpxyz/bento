下面给你一份\*\*“可落地实现”的倪海夏/倪海厦流（下文简称“倪派”）紫微斗数方法论说明\*\*，面向工程化实现（Python＋`sxtwl`≥2.x），把玄学口径拆成可配置、可计算、可验证的步骤。文末给出需要你拍板的**实现选项**，确定后我就按此直接开写代码与测试用例。

> **先澄清**：你文中写“倪海夏”，大众更熟悉的是台湾中医师**倪海厦**。若你指的确为倪海厦所讲授/流传的斗数口径，下文按“倪派（立春分年、重四化连动、重动盘实占）”来抽象化；若你另有所指（同名其他门派），请告诉我引用依据，我再切换表格。

---

## 1. 方法论总览（工程化视角）

**核心目标**：以**立春分年**为年界，建立**本命盘 → 大限盘 → 流年/流月/流日飞化连动**的完整可计算链条；并将各类**流派差异**固化为**可配置表**与**策略函数**，以避免被“手工口诀/版本差异”卡住。

**总流程（Pipeline）**：

1. **时间基准**

   * 输入：公历出生时间、出生地经纬度、性别。
   * 可选校正：**真太阳时**（经度校正与时区换算），是否使用**夏令时**历史规则。
   * 输出：校正后的北京时间/地方时（可双轨保留，供对照）。

2. **历法与干支**（`sxtwl`≥2.x）

   * 以**交节时刻**取**立春**为**年界**（不是农历正月初一）。
   * 计算：年干支（以立春分年）、月（按节令或农历月，两种可配）、日干支、时支。
   * 输出：`{year_gz, month_gz?, day_gz, hour_zhi, li_chun_dt, jd}` 等。

3. **宫位体系**

   * 十二宫：命、兄弟、夫妻、子女、财帛、疾厄、迁移、仆役、官禄、田宅、福德、父母（固定顺逆序）。
   * **命宫/身宫起法**（**可配置策略**）：

     * 倪派常见是**月+时**起命宫（以农历月序与时支序求命宫），身宫另有流派差异（如以时支起身宫或以命宫与时支合算）。
     * 我会将**命宫公式**与**身宫公式**做成函数策略：`strategy_ming_gong()`, `strategy_shen_gong()`。

4. **星曜布置**

   * **主星14颗**与**辅星系**（禄存、擎羊、陀罗、火铃、左辅右弼、天魁天钺、文昌文曲、地空地劫等）。
   * 每一颗星的**排盘规则**都是**纯表驱动**：以（年/月/日/时/命宫/身宫）等参数映射宫位。
   * **实现方式**：

     * 建立**星曜规则表**（版本化：如《全书表》《钦天派》《某老师口径》），支持 YAML/JSON 装载。
     * 统一入口 `place_stars(params, tables, strategy)` 返回每星落宫。

5. **四化（飞化）体系**

   * 倪派采用\*\*“以年干定四化”**（化禄、化权、化科、化忌）为主轴，并在**大限/流年/流月/流日**叠加**层层飞化\*\*，观察**本命四化 × 限四化 × 流四化**的**冲合克**与**三方四正**联动。
   * **关键点**：**四化配表**有多个版本（传统/港台不同老师表）。**实现为可配置表**，例如：

     ```yaml
     four_transforms:
       version: "ni派-年干四化-v1"
       mapping:
         甲: { 禄: 贪狼, 权: 巨门, 科: 武曲, 忌: 太阳 }   # 示例：仅演示结构，不代表真实表
         乙: { ... }
         ...
     ```
   * 叠加顺序：**本命四化**先行；随后对**大限→流年→流月→流日**逐层注入四化，形成\*\*飞化箭头（A星化忌飞入某宫）\*\*的追踪图。
   * 输出：在各盘层级生成**四化事件集**（事件=“哪一颗星在何层被化××，飞入/飞出某宫”）。

6. **大限/流年/流月/流日/流时**（动盘）

   * **顺逆行规则**：**阳男阴女顺行，阴男阳女逆行**（常规斗数规则，倪派沿用；如有变体我做成可配）。
   * **大限起岁**：常见以虚岁与出生月差计算第一大限起始岁数（有多版本，我会做成策略：`strategy_da_xian_start_age()`）。
   * 大限宫位顺推/逆推，每限10年。
   * 流年以周岁（或虚岁）年对号入座宫位；流月/流日/流时按相应推转法。
   * 每层**注入对应四化**与**太岁/太阴/小限等辅助飞星**，形成**层叠动盘**。

7. **格局与断法（可选知识库）**

   * 模块化的**格局规则**（如杀破狼、紫府朝垣、日月照壁等）与**不喜/喜会**规则；
   * 用**规则引擎**或**谓词函数集合**：`rules.evaluate(state) -> insights`。
   * 输出结构化“断语要点”（供前端展示与可视化）。

8. **可视化与验证**

   * 宫盘图（12边形/环形）、飞化箭头流入流出、三方四正高亮。
   * **回测/校核**：选择有口径的样例盘与手工盘对照，用单元测试确保**星位/四化/限飞化**一致。

---

## 2. 倪派的“立春分年”与实现要点

* **年界以立春为准**：在**立春时刻之前**出生者，年干支取**上一年**；立春及之后，取**当年**。
* **为什么重要**：四化“以年干定”，若年界取错（用正月初一或公历1月1日），**四化将全部漂移**，后续飞化联动失真。
* **实现**（`sxtwl`≥2.x）：

  1. 以出生地经度、时区得到**本地时间**；
  2. 用 `sxtwl` 拿到当年**立春的精确时刻（UTC或本地）**；
  3. 比较出生时刻与立春时刻决定 `year_gz`；
  4. 其它节令（节气）可用于**月界**（若采用“节令月”算法）。

> 你此前提到“**以辛丑年为例**”与“**集成 sxtwl**”，这一步会直接给到**精确到秒**的立春交节时刻，并以此回填**年干支**与**四化表**索引。

---

## 3. 命宫/身宫起法（推荐做成“策略＋参数化”）

常见三类（示意）：

1. **月＋时起命宫**（广泛流行，倪派常见）：

   * 以农历\*\*月序（1-12）**与**时支序（1-12）\*\*相加（或特定公式）定位命宫；
   * **身宫**常以**时支**或**命宫＋时支**再运算确定。
2. **月＋日＋时**综合起命宫（部分北派/全书旧表）。
3. **节令月**＋时起命/身（以节令为月界）。

**实现建议**：

* 提供 `MING_GONG_STRATEGY = "ni_v1" | "traditional_v2" | ...`；
* 具体公式封装进策略函数，配对**回归测试**样例盘，确保策略落点稳定。

---

## 4. 星曜布置与四化（数据驱动）

* **星曜布置**：

  * **主星14**：紫微、天机、太阳、武曲、天同、廉贞、天府、太阴、贪狼、巨门、天相、天梁、七杀、破军。
  * **左/右、昌/曲、魁/钺、禄存、羊/陀、火/铃、空/劫、小耗/大耗、天喜/红鸾、天刑/天姚、天马/解神**等按表落位。
  * **表格来源**：我会将“倪派口径”与“通行口径”区分版本；如你有**老师笔记/教材表**，可一并导入。

* **四化表**：

  * 以\*\*年干（甲乙丙丁…癸）\*\*映射四化星（禄/权/科/忌）——**版本化存储**。
  * **注意**：市面**四化表存在差异**，不同老师“某干化××星”不完全一致。为避免争议，我把表**做成独立资源文件**，便于切换比对。

* **层叠飞化**：

  * **本命四化** → 注入**大限四化** → 注入**流年四化** → …（形成**箭头追踪**）。
  * 提供 `collect_transforms(level)` 输出该层新增四化事件；
  * 提供 `stack_transforms(levels=[natal, decade, year, month, day])` 生成**全景事件流**。

---

## 5. 大限/流年/流月/流日的实作关键

* **顺逆**：阳男阴女顺，阴男阳女逆（若倪派另有修正规则，我会开放开关）。
* **大限起算**（可选策略）：

  * ① 以**虚岁**并按**出生月→下一个节令月**的剩余月数折算首限起岁；
  * ② 以**周岁**整十为分段，首限对齐实际岁数（更贴近西历）。
* **落宫**：按顺/逆行每十年推进一个宫位。
* **流年/月/日/时**：分别以岁/月/日/时序推进，叠加四化（与太岁、小限等）。
* **输出**：给出每层**主星/辅星/四化**在**三方四正**的会合关系，标注\*\*“化忌飞入×宫”\*\*、“**禄权夹命**”等观察点。

---

## 6. 断法模块（可选）

* 以**规则库**组织：

  * **格局识别**：杀破狼、紫府朝垣、日月照壁、机月同梁、武贪、铃昌夹印等；
  * **四化冲会**：如“**忌入命福，逢化权化禄解**”“禄入财帛三方会照”等；
* 每条规则是**谓词函数**：`predicate(state) -> { matched: bool, evidence: [...], note: "" }`。
* 形成可解释输出，便于业务用户阅读与校核。

---

## 7. 与其他流派的**可配置差异点**

1. **年界**：立春 vs 正月初一 vs 公历1月1日（倪派取**立春**）。
2. **月界**：节令月 vs 阴历月。
3. **命宫/身宫**起法公式。
4. **四化表**版本（最关键差异源）。
5. **真太阳时**是否启用（倪派倾向**重精确时刻**，建议启用）。
6. **顺逆与大限起算**的细节。
7. **小星系/杂曜**采用范围（全收还是简化）。

---

## 8. 工程实现框架（Python＋`sxtwl`≥2.0）

**模块划分**：

* `calendars/`：`sxtwl`封装（立春时刻、节令月、干支、真太阳时换算）。
* `strategies/`：命宫/身宫/大限起算/顺逆等策略。
* `tables/`：星曜落位表、四化表（多版本 YAML/JSON）。
* `engine/`：

  * `place_stars(params, tables, strategy)`
  * `compute_transforms(level, year_gan, tables)`
  * `stack_levels(natal, da_xian, liu_nian, ...)`
* `rules/`：格局与断法谓词集。
* `viz/`：宫盘与飞化箭头可视化（可输出SVG/PNG）。
* `tests/`：回归测试与样例盘校核。

**关键数据结构（示意）**：

```python
@dataclass
class BirthInfo:
    dt_local: datetime
    lat: float
    lon: float
    gender: Literal["M","F"]
    use_true_solar_time: bool = True

@dataclass
class ChronoKeys:
    year_gz: str
    month_key: str  # "lunar_5" or "solar_jy_立秋后第x月"
    day_gz: str
    hour_zhi: str
    li_chun_dt: datetime

@dataclass
class ChartState:
    palace_of: dict[str, str]   # 星曜->宫位
    transforms: list[dict]      # [{level:"natal|decade|year|...", star:"文昌", type:"禄|权|科|忌", to:"宫位"}]
    meta: dict                  # 顺逆、年龄段、三方四正索引等
```

---

## 9. 校核与样例

* 选取**你提供的手工排盘/传统学习资料**中的**样例盘**（特别是“辛丑年”举例，且明确立春前/后的边界样例），逐一对照：

  * **星位完全一致**；
  * **四化飞入飞出完全一致**；
  * **大限、流年落宫与顺逆一致**。
* 建立**单元测试**：当我们更换**四化表版本**或**命宫策略**时，测试能**精确揭示差异**。

---

## 10. 你需要拍板的实现选项

为保证第一次实现就贴近你要的“倪派”口径，请确认/选择：

1. **老师与口径**：确认是**倪海厦**（台湾中医师）所述斗数体系？是否有**指定教材/笔记表**可导入？
2. **年界**：✅ **立春分年**（默认）。
3. **月界**：

   * A. **节令月**（按节气界）
   * B. **阴历月**（农历）
4. **命宫/身宫起法**：

   * A. **月＋时起命宫**，身宫以**时支**（倪派常见）
   * B. 其它（请给公式或资料）
5. **四化表版本**：

   * A. 你指定的“倪派四化表”
   * B. 我先放入**通行版本**作占位，待你提供“倪派表”再切换
6. **真太阳时**：

   * A. ✅ 启用（建议）
   * B. 关闭（以时区民用时计时）
7. **大限起算与顺逆**：

   * 顺逆：✅ 阳男阴女顺、阴男阳女逆
   * 起算：

     * A. 虚岁＋节令折算首限
     * B. 周岁十年一限（更直观）

---

## 11. 下一步

* 你确认上面的**7项选型**后，我将：

  1. 初始化`tables/`（星曜表＋四化表**可切换版本**）；
  2. 封装`sxtwl`（立春/节令月/干支/真太阳时）；
  3. 完成**命盘→大限→流年**核心计算与**四化层叠**；
  4. 给出\*\*“辛丑年”样例**与**单元测试\*\*；
  5. 若需要，再加**SVG宫盘＋飞化箭头可视化**。

需要的话，我也可以**先给出最小可运行骨架**（含数据占位与1个样例盘），你边看边指定你要的“倪派四化表/命宫公式”，我们再快速替换升级。你更倾向先上哪一条？
