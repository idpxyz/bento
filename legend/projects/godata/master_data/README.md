# 天干地支管理系统

基于领域驱动设计（DDD）和SOLID原则构建的中国传统历法管理系统。

## 架构概述

### 领域驱动设计（DDD）架构

本项目采用经典的DDD分层架构：

```
godata/master_data/
├── domain/                 # 领域层
│   ├── aggregate/         # 聚合根
│   │   ├── tiangan.py    # 天干聚合根
│   │   └── dizhi.py      # 地支聚合根
│   ├── repository/       # 仓储接口
│   │   ├── tiangan_repository.py
│   │   └── dizhi_repository.py
│   └── value_objects/    # 值对象
│       ├── tiangan_combination.py
│       └── dizhi_combination.py
├── application/           # 应用层
│   └── services/
│       ├── tiangan_service.py
│       └── dizhi_service.py
├── infrastructure/        # 基础设施层
│   └── repositories/
│       ├── memory_tiangan_repository.py
│       └── memory_dizhi_repository.py
├── interface/            # 接口层
│   └── api/
│       ├── tiangan_api.py
│       └── dizhi_api.py
└── main.py              # 应用入口
```

### 各层职责

1. **领域层（Domain Layer）**
   - 包含业务核心逻辑和规则
   - 定义聚合根、实体、值对象
   - 定义仓储接口（不包含实现）

2. **应用层（Application Layer）**
   - 协调领域对象完成业务用例
   - 处理事务边界
   - 不包含业务规则

3. **基础设施层（Infrastructure Layer）**
   - 实现仓储接口
   - 处理数据持久化
   - 提供外部服务集成

4. **接口层（Interface Layer）**
   - 处理HTTP请求和响应
   - 数据验证和转换
   - 错误处理

## SOLID原则应用

### 1. 单一职责原则（SRP）
- `TianganService` 只负责天干相关的业务逻辑
- `DizhiService` 只负责地支相关的业务逻辑
- `TianganRepository` 只负责天干数据的存取
- `DizhiRepository` 只负责地支数据的存取

### 2. 开闭原则（OCP）
- 通过仓储接口可以轻松扩展不同的存储实现
- 值对象的设计使得组合关系可以灵活扩展

### 3. 里氏替换原则（LSP）
- 所有仓储实现都可以替换接口而不影响业务逻辑
- 值对象的设计保证了行为的一致性

### 4. 接口隔离原则（ISP）
- 仓储接口只包含必要的方法
- 服务接口职责单一，不会强制实现不需要的方法

### 5. 依赖倒置原则（DIP）
- 应用层依赖仓储接口而非具体实现
- 通过依赖注入实现松耦合

## 天干设计分析

### 原始设计的不足：
1. 缺少纳音属性
2. 缺少天干序号
3. 缺少合化关系
4. 缺少业务验证逻辑

### 改进后的设计：
1. **完整的属性定义**：包含名称、序号、阴阳、五行、纳音、描述、合化关系
2. **业务规则验证**：在构造函数中验证天干属性的合理性
3. **领域方法**：提供获取下一个天干、判断相合性等方法
4. **值对象**：使用`TianganCombination`表示天干组合关系

### 符合中国传统文化：
- **阴阳属性**：正确区分阳干（甲丙戊庚壬）和阴干（乙丁己辛癸）
- **五行属性**：甲乙木、丙丁火、戊己土、庚辛金、壬癸水
- **纳音属性**：甲己海中金、乙庚炉中火、丙辛白蜡金、丁壬杨柳木、戊癸井泉水
- **合化关系**：甲己合土、乙庚合金、丙辛合水、丁壬合木、戊癸合火

## 地支设计分析

### 地支关系设计：
1. **六合关系**：子丑合土、寅亥合木、卯戌合火、辰酉合金、巳申合水、午未合土
2. **六冲关系**：子午相冲、丑未相冲、寅申相冲、卯酉相冲、辰戌相冲、巳亥相冲
3. **三合关系**：
   - 寅午戌三合火局
   - 亥卯未三合木局
   - 巳酉丑三合金局
   - 申子辰三合水局

### 地支属性设计：
- **基本属性**：名称、序号、生肖、阴阳、五行、纳音、描述
- **业务验证**：验证地支属性的合理性
- **关系方法**：提供六合、六冲、三合关系的查询方法
- **值对象**：使用`DizhiCombination`和`SanHeGroup`表示地支关系

### 符合中国传统文化：
- **生肖对应**：子鼠、丑牛、寅虎、卯兔、辰龙、巳蛇、午马、未羊、申猴、酉鸡、戌狗、亥猪
- **阴阳属性**：阳支（子寅辰午申戌）、阴支（丑卯巳未酉亥）
- **五行属性**：子亥水、丑辰未戌土、寅卯木、巳午火、申酉金
- **纳音属性**：子丑海中金、寅卯炉中火、辰巳白蜡金、午未杨柳木、申酉井泉水、戌亥平地木

## 运行方式

### 安装依赖
```bash
pip install fastapi uvicorn pydantic
```

### 启动应用
```bash
python main.py
```

### API文档
启动后访问：http://localhost:8000/docs

## 主要功能

### 天干管理
- 获取所有天干
- 根据名称、序号查询天干
- 根据五行、阴阳属性筛选天干
- 创建新的天干（带验证）
- 天干合化关系查询

### 地支管理
- 获取所有地支
- 根据名称、序号、生肖查询地支
- 根据五行、阴阳属性筛选地支
- 创建新的地支（带验证）
- 六合、六冲、三合关系查询
- 三合局创建和查询

### 示例API调用

#### 天干相关
```bash
# 获取所有天干
GET /tiangan/

# 根据名称获取天干
GET /tiangan/甲

# 检查天干组合
POST /tiangan/combination
{
    "tiangan1": "甲",
    "tiangan2": "己"
}

# 获取与甲相合的天干
GET /tiangan/甲/compatible
```

#### 地支相关
```bash
# 获取所有地支
GET /dizhi/

# 根据名称获取地支
GET /dizhi/子

# 检查地支六合
POST /dizhi/liu-he
{
    "dizhi1": "子",
    "dizhi2": "丑"
}

# 检查地支六冲
POST /dizhi/liu-chong
{
    "dizhi1": "子",
    "dizhi2": "午"
}

# 检查地支三合
POST /dizhi/san-he
{
    "dizhi1": "寅",
    "dizhi2": "午"
}

# 创建三合局
POST /dizhi/san-he-group
{
    "dizhi1": "寅",
    "dizhi2": "午",
    "dizhi3": "戌"
}

# 获取地支的所有关系
GET /dizhi/子/relationships

# 获取所有三合局
GET /dizhi/san-he-groups/all
```

## 设计优势

1. **可测试性**：通过依赖注入和接口隔离，便于单元测试
2. **可维护性**：清晰的层次结构和职责分离
3. **可扩展性**：易于添加新的天干地支属性和业务规则
4. **可替换性**：仓储实现可以轻松替换（内存、数据库等）
5. **文化准确性**：严格遵循中国传统文化中的天干地支理论
6. **关系完整性**：完整支持六合、六冲、三合等地支关系

## 最佳实践

1. **领域逻辑封装**：所有业务规则都在领域层实现
2. **依赖注入**：使用FastAPI的依赖注入系统
3. **错误处理**：统一的异常处理和HTTP状态码
4. **数据验证**：使用Pydantic进行请求和响应验证
5. **文档化**：详细的API文档和代码注释
6. **值对象设计**：使用不可变的值对象表示业务概念

## 文化背景

### 天干地支的起源
天干地支是中国古代历法的重要组成部分，用于纪年、纪月、纪日、纪时。天干有十个：甲、乙、丙、丁、戊、己、庚、辛、壬、癸；地支有十二个：子、丑、寅、卯、辰、巳、午、未、申、酉、戌、亥。

### 六合、六冲、三合的意义
- **六合**：地支之间的和谐关系，表示合作、融合
- **六冲**：地支之间的冲突关系，表示对立、矛盾
- **三合**：三个地支组成一个五行局，表示力量的聚集和增强

这个设计不仅符合DDD和SOLID原则，还准确反映了中国传统文化中天干地支的理论体系，为后续扩展八字、命理等功能奠定了良好的架构基础。 